<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Sentient AI Movie Assistant</title>
<style>
  body{margin:0;font-family:Inter,system-ui,Arial;background:#000;color:#f2f2f2}
  header{padding:16px;text-align:center;color:#00ffc3;font-weight:800;letter-spacing:.5px}
  main{display:grid;grid-template-columns:2fr 1fr;gap:16px;padding:16px;height:calc(100vh - 70px);box-sizing:border-box}
  #results,#chat{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;overflow:auto}
  #results{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:rgba(255,255,255,.06);border-radius:12px;overflow:hidden;box-shadow:0 0 12px rgba(0,0,0,.35)}
  .card img{width:100%;height:300px;object-fit:cover}
  .card .info{padding:10px}
  .card h4{margin:0 0 6px;color:#00ffc3;font-size:1rem}
  .meta{opacity:.9;font-size:.9rem}
  #chat{display:flex;flex-direction:column}
  #history{flex:1;overflow:auto;margin-bottom:10px}
  .m{margin:8px 0;line-height:1.5}
  .m.u strong{color:#00b7ff}
  .m.b strong{color:#00ffc3}
  #controls{display:flex;gap:8px}
  #q{flex:1;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,.1);color:#fff;outline:none}
  button{background:linear-gradient(135deg,#00ffc3,#00b7ff);border:none;border-radius:10px;padding:12px 16px;font-weight:700;color:#000;cursor:pointer}
  #status{margin-top:8px;font-style:italic;color:#aaa}
</style>
</head>
<body>
  <header>Sentient AI Movie Assistant</header>
  <main>
    <section id="results"></section>
    <section id="chat">
      <div id="history"></div>
      <div id="controls">
        <input id="q" placeholder="Ask about movies‚Ä¶ e.g. ‚ÄòBest Korean action after 2015 7+‚Äô" />
        <button id="ask">Ask</button>
        <button id="clear">Clear</button>
      </div>
      <div id="status"></div>
    </section>
  </main>

<script>
const state = {
  context: {
    type: null,          // "movie" | "tv" | null
    language: null,      // ISO like "ko", "en", ‚Ä¶
    year: null,
    year_after: null,
    year_before: null,
    min_rating: null,
    actor: null,
    director: null,
    genre: null          // "Action", "Drama", ‚Ä¶
  }
};

const el = (id)=>document.getElementById(id);
const H = el('history'), R = el('results'), S = el('status');

function addMsg(role, text){
  const d = document.createElement('div');
  d.className = 'm ' + (role==='user'?'u':'b');
  d.innerHTML = `<strong>${role==='user'?'You':'Dobby'}:</strong> ${text}`;
  H.appendChild(d);
  H.scrollTop = H.scrollHeight;
}
function clearUI(){
  H.innerHTML = '';
  R.innerHTML = '';
  S.textContent = '';
}
function card(movie){
  const div = document.createElement('div');
  div.className = 'card';
  const poster = movie.primaryImage || movie.poster || '';
  const img = poster ? `<img src="${poster}" alt="${movie.primaryTitle||movie.title||'Poster'}" />` : '';
  const title = movie.primaryTitle || movie.title || movie.originalTitle || 'Untitled';
  const year = movie.startYear || movie.year || '';
  const imdb = movie.id ? `https://www.imdb.com/title/${movie.id}/` : (movie.imdbID?`https://www.imdb.com/title/${movie.imdbID}/` : '#');
  const rating = movie.averageRating ?? movie.imdbRating ?? 'N/A';
  const metascore = movie.metascore ?? movie.Metascore ?? null;

  div.innerHTML = `
    ${img}
    <div class="info">
      <h4>${title}</h4>
      <div class="meta">‚≠ê ${rating} ${metascore?` | Metascore ${metascore}`:''} ${year?` | ${year}`:''}</div>
      <p>${(movie.description||movie.overview||'').slice(0,140)}${(movie.description||movie.overview||'').length>140?'‚Ä¶':''}</p>
      <a href="${imdb}" target="_blank">Open on IMDb</a>
    </div>`;
  return div;
}

async function ask(q){
  addMsg('user', q);
  S.textContent = 'ü§ñ Understanding request‚Ä¶';
  try{
    const res = await fetch('/api/ask', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text: q, context: state.context })
    });
    const data = await res.json();
    if(data.error){
      addMsg('bot', '‚ö†Ô∏è ' + data.error);
      S.textContent = '';
      return;
    }
    // update context memory
    state.context = data.context || state.context;

    // results
    R.innerHTML = '';
    (data.results||[]).forEach(m => R.appendChild(card(m)));
    addMsg('bot', data.summary || `‚úÖ Done. Found ${data.results?.length||0}.`);

    // follow-up prompt
    if(data.followup){
      addMsg('bot', data.followup);
    }
    S.textContent = '';
  }catch(e){
    addMsg('bot','‚ö†Ô∏è Network error.');
    console.error(e);
    S.textContent = '';
  }
}

el('ask').addEventListener('click', ()=> {
  const v = el('q').value.trim();
  if(!v) return;
  ask(v);
  el('q').value = '';
  el('q').focus();
});
el('clear').addEventListener('click', ()=>{ clearUI(); state.context = {type:null,language:null,year:null,year_after:null,year_before:null,min_rating:null,actor:null,director:null,genre:null}; });
el('q').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    e.preventDefault();
    const v = el('q').value.trim();
    if(!v) return;
    ask(v);
    el('q').value = '';
  }
});
</script>
</body>
</html>
